# ================= BUILD =================
FROM mcr.microsoft.com/dotnet/sdk:10.0 AS BUILD

COPY SpheneAPI /SpheneAPI
COPY server/SpheneServer/SpheneShared /server/SpheneServer/SpheneShared
COPY server/SpheneServer/SpheneAuthService /server/SpheneServer/SpheneAuthService

# Build SpheneAPI
WORKDIR /SpheneAPI/SpheneAPI
RUN dotnet build \
    -c Release \
    -o /SpheneAPI/bin \
    Sphene.API.csproj

# Publish Auth Service
WORKDIR /server/SpheneServer/SpheneAuthService
RUN dotnet publish \
    -c Release \
    -r linux-x64 \
    --self-contained false \
    -o /build \
    SpheneAuthService.csproj


# ================= RUNTIME =================
FROM mcr.microsoft.com/dotnet/aspnet:10.0

WORKDIR /opt/SpheneAuthService
COPY --from=BUILD /build .

# .NET 10 runtime already provides non-root user
USER app

ENTRYPOINT ["dotnet", "SpheneAuthService.dll"]